// ─────────────────────────────────────────────────────────────
//  VictorOS ERP — Prisma Schema
//  PostgreSQL 16 · PCGE-aligned accounting · Peru compliance
// ─────────────────────────────────────────────────────────────

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ══════════════════════════════════════════════════════════════
//  ENUMS
// ══════════════════════════════════════════════════════════════

enum UserRole {
  SUPER_ADMIN
  FINANCE_MGR
  OPS_MGR
  SALES_MGR
  WAREHOUSE
  PRODUCTION
  PROCUREMENT
  ACCOUNTANT
  SALES_AGENT
  DRIVER
  CUSTOMER_B2C
  CUSTOMER_B2B
  AUDITOR
}

enum WarehouseType {
  RAW_MATERIAL
  FINISHED_GOODS
  PACKAGING
  GENERAL
}

enum StockMovementType {
  PURCHASE_RECEIPT
  PRODUCTION_CONSUMPTION
  WASTE
  ADJUSTMENT
  TRANSFER_IN
  TRANSFER_OUT
  RETURN
  OPENING_BALANCE
}

enum WasteType {
  SPOILAGE
  PRODUCTION_OVER_RUN
  DAMAGE
  EXPIRED
  OTHER
}

enum RecipeStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum ProductionOrderStatus {
  DRAFT
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PurchaseOrderStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  SENT
  PARTIAL_RECEIVED
  FULLY_RECEIVED
  INVOICED
  PAID
  CANCELLED
}

enum CustomerType {
  B2C
  B2B
}

// B2B client categories (mandatory for B2B, not applicable for B2C)
enum CustomerCategory {
  SUPERMERCADO      // SPSA, Cencosud, Tottus
  TIENDA_NATURISTA  // Tiendas naturistas
  CAFETERIA         // Cafeterías
  RESTAURANTE       // Restaurantes
  HOTEL             // Hoteles
  EMPRESA           // Empresa genérica
  OTROS             // Otros
}

enum DocType {
  DNI
  RUC
  CE
  PASAPORTE
}

enum PricingType {
  FIXED_PRICE
  DISCOUNT_PCT
}

enum TaxClass {
  TAXABLE_IGV18
  EXEMPT
  EXPORT
}

enum OrderStatus {
  CART
  PENDING_PAYMENT
  PAID
  CONFIRMED
  IN_PRODUCTION
  READY_FOR_DISPATCH
  OUT_FOR_DELIVERY
  DELIVERED
  INVOICED
  COMPLETED
  CANCELLED
  REFUND_PENDING
  REFUNDED
  DELIVERED_DISPUTE
}

enum OrderChannel {
  ECOMMERCE
  B2B_PORTAL
  SALES_AGENT
  IN_STORE
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
}

enum InvoiceDocType {
  FACTURA
  BOLETA
  NOTA_CREDITO
  NOTA_DEBITO
  GUIA_REMISION
}

enum InvoiceStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  VOIDED
}

enum InvoiceEntityType {
  CUSTOMER
  SUPPLIER
}

enum JournalEntryStatus {
  DRAFT
  POSTED
  REVERSED
}

enum SourceModule {
  SALES
  PROCUREMENT
  PRODUCTION
  PAYROLL
  MANUAL
  ADJUSTMENT
  BANKING
}

enum ContractType {
  INDEFINIDO
  PLAZO_FIJO
  PART_TIME
}

enum PensionSystem {
  AFP
  ONP
}

enum EmploymentType {
  PLANILLA   // On payroll — ESSALUD, CTS, vacations, gratificación apply
  RXH        // Recibo por Honorarios — 8% IR retention only (if > S/1500/month)
}

enum PayPeriodType {
  MONTHLY
  QUINCENA
}

enum PayPeriodStatus {
  OPEN
  PROCESSED
  PAID
  CLOSED
}

enum PayslipStatus {
  DRAFT
  CONFIRMED
  PAID
}

enum DeliveryRouteStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
}

enum DeliveryJobStatus {
  PENDING
  IN_TRANSIT
  DELIVERED
  FAILED
  RESCHEDULED
}

enum IncidentType {
  NOT_HOME
  ADDRESS_ERROR
  DAMAGED
  REFUSED
  OTHER
}

enum ForecastStatus {
  RUNNING
  COMPLETED
  FAILED
}

enum PlanSuggestionStatus {
  SUGGESTED
  UNDER_REVIEW
  CONFIRMED
  REJECTED
}

enum DemandSource {
  B2B_ORDER
  FORECAST_B2C
  FORECAST_B2B
}

enum MatchStatus {
  MATCHED
  DISPUTED
  PENDING
}

enum ComprobanteDocType {
  FACTURA
  BOLETA
  NOTA_CREDITO
  NOTA_DEBITO
  GUIA_REMISION
  ORDEN_COMPRA
  RECIBO_HONORARIOS
  TICKET
  LIQUIDACION_COMPRA
  OTRO
}

enum ComprobanteArchivoTipo {
  PDF
  IMAGEN
  XML
}

enum ComprobanteEstado {
  PENDIENTE
  VALIDADO
  OBSERVADO
  ANULADO
}

enum ComprobanteSource {
  MANUAL
  EMAIL
}

// ══════════════════════════════════════════════════════════════
//  SHARED / SYSTEM
// ══════════════════════════════════════════════════════════════

model User {
  id               String    @id @default(uuid())
  email            String    @unique
  passwordHash     String
  fullName         String
  roles            UserRole[]
  isActive         Boolean   @default(true)
  lastLoginAt      DateTime?
  mfaSecret        String?
  mfaEnabled       Boolean   @default(false)
  refreshTokenHash String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  createdProductionOrders ProductionOrder[] @relation("CreatedBy")
  approvedRecipes         Recipe[]          @relation("ApprovedBy")
  approvedPurchaseOrders  PurchaseOrder[]   @relation("ApprovedBy")
  auditLogs               AuditLog[]
  createdJournalEntries   JournalEntry[]

  @@map("users")
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  action      String   // e.g. "UPDATE", "CREATE", "DELETE", "APPROVE"
  module      String   // e.g. "sales_orders", "invoices"
  recordId    String
  beforeState Json?
  afterState  Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([module, recordId])
  @@index([userId, createdAt])
  @@map("audit_logs")
}

model SystemConfig {
  id           String   @id @default(uuid())
  key          String   @unique
  value        Json
  description  String?
  effectiveFrom DateTime @default(now())
  updatedAt    DateTime @updatedAt
  updatedBy    String?

  @@map("system_config")
}

// ══════════════════════════════════════════════════════════════
//  INVENTORY
// ══════════════════════════════════════════════════════════════

model Ingredient {
  id             String   @id @default(uuid())
  sku            String   @unique
  name           String
  category       String   // flour|sugar|fat|dairy|egg|flavoring|packaging|other
  baseUom        String   // kg|litre|unit|g|ml
  avgCostPen     Decimal  @default(0) @db.Decimal(14, 6)
  isPerishable   Boolean  @default(false)
  shelfLifeDays  Int?
  isActive       Boolean  @default(true)
  allergenFlags  String[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  stockLevels      StockLevel[]
  stockMovements   StockMovement[]
  batches          Batch[]
  bomLines         BOMLine[]
  reorderRules     ReorderRule[]
  supplierPrices   SupplierPriceList[]
  poLines          PurchaseOrderLine[]
  alertConfig      IngredientAlert?

  @@map("ingredients")
}

model UOMConversion {
  id          String  @id @default(uuid())
  fromUom     String
  toUom       String
  factor      Decimal @db.Decimal(14, 8) // 1 fromUom = factor toUom
  ingredientId String? // null = universal conversion

  @@unique([fromUom, toUom, ingredientId])
  @@map("uom_conversions")
}

model Warehouse {
  id        String        @id @default(uuid())
  name      String
  type      WarehouseType
  address   String?
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())

  // Relations
  stockLevels    StockLevel[]
  stockMovements StockMovement[]
  reorderRules   ReorderRule[]

  @@map("warehouses")
}

model StockLevel {
  id              String    @id @default(uuid())
  ingredientId    String
  ingredient      Ingredient @relation(fields: [ingredientId], references: [id])
  warehouseId     String
  warehouse       Warehouse  @relation(fields: [warehouseId], references: [id])
  qtyOnHand       Decimal   @default(0) @db.Decimal(14, 4)
  qtyReserved     Decimal   @default(0) @db.Decimal(14, 4)
  avgCostPen      Decimal   @default(0) @db.Decimal(14, 6)
  lastMovementAt  DateTime?
  updatedAt       DateTime  @updatedAt

  @@unique([ingredientId, warehouseId])
  @@map("stock_levels")
}

model StockMovement {
  id             String            @id @default(uuid())
  type           StockMovementType
  refDocType     String?           // po_id|production_order_id|adjustment_id
  refDocId       String?
  ingredientId   String
  ingredient     Ingredient        @relation(fields: [ingredientId], references: [id])
  warehouseId    String
  warehouse      Warehouse         @relation(fields: [warehouseId], references: [id])
  batchId        String?
  batch          Batch?            @relation(fields: [batchId], references: [id])
  qtyIn          Decimal           @default(0) @db.Decimal(14, 4)
  qtyOut         Decimal           @default(0) @db.Decimal(14, 4)
  unitCostPen    Decimal           @db.Decimal(14, 6)
  totalCostPen   Decimal           @db.Decimal(14, 4)
  balanceAfter   Decimal           @db.Decimal(14, 4)
  notes          String?
  journalEntryId String?
  createdAt      DateTime          @default(now())
  createdBy      String

  @@index([ingredientId, createdAt])
  @@index([refDocType, refDocId])
  @@map("stock_movements")
}

model Batch {
  id               String    @id @default(uuid())
  ingredientId     String
  ingredient       Ingredient @relation(fields: [ingredientId], references: [id])
  supplierLotNo    String?
  receivedDate     DateTime
  expiryDate       DateTime?
  qtyReceived      Decimal   @db.Decimal(14, 4)
  qtyRemaining     Decimal   @db.Decimal(14, 4)
  unitCostPen      Decimal   @db.Decimal(14, 6)
  supplierId       String?
  createdAt        DateTime  @default(now())

  stockMovements StockMovement[]

  @@index([ingredientId, expiryDate])
  @@map("batches")
}

model ReorderRule {
  id                  String     @id @default(uuid())
  ingredientId        String
  ingredient          Ingredient @relation(fields: [ingredientId], references: [id])
  warehouseId         String
  warehouse           Warehouse  @relation(fields: [warehouseId], references: [id])
  minQty              Decimal    @db.Decimal(14, 4)
  maxQty              Decimal    @db.Decimal(14, 4)
  reorderPoint        Decimal    @db.Decimal(14, 4)
  safetyStockQty      Decimal    @db.Decimal(14, 4)
  leadTimeDays        Int        @default(1)
  preferredSupplierId String?

  @@unique([ingredientId, warehouseId])
  @@map("reorder_rules")
}

// Per-ingredient dashboard & alert settings (threshold alerts + email notifications)
model IngredientAlert {
  id              String     @id @default(uuid())
  ingredientId    String     @unique
  ingredient      Ingredient @relation(fields: [ingredientId], references: [id])
  alertThreshold  Decimal    @default(0) @db.Decimal(14, 4)  // warn when stock falls below
  minThreshold    Decimal    @default(0) @db.Decimal(14, 4)  // critical minimum
  alertEmails     String[]   @default([])                    // who to email when triggered
  dashboardUnit   String     @default("qty")                 // qty | pct | und
  lastAlertAt     DateTime?                                   // spam throttle: warn level
  lastMinAlertAt  DateTime?                                   // spam throttle: critical level

  @@map("ingredient_alerts")
}

// ══════════════════════════════════════════════════════════════
//  PRODUCTION
// ══════════════════════════════════════════════════════════════

model Recipe {
  id            String       @id @default(uuid())
  productId     String
  product       Product      @relation(fields: [productId], references: [id])
  version       Int          @default(1)
  effectiveFrom DateTime
  effectiveTo   DateTime?
  yieldQty      Decimal      @db.Decimal(10, 4)
  yieldUom      String
  status        RecipeStatus @default(DRAFT)
  changeReason  String?
  approvedBy    String?
  approver      User?        @relation("ApprovedBy", fields: [approvedBy], references: [id])
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  createdBy     String

  bomLines         BOMLine[]
  productionOrders ProductionOrder[]

  @@unique([productId, version])
  @@map("recipes")
}

model BOMLine {
  id             String     @id @default(uuid())
  recipeId       String
  recipe         Recipe     @relation(fields: [recipeId], references: [id])
  ingredientId   String
  ingredient     Ingredient @relation(fields: [ingredientId], references: [id])
  qtyRequired    Decimal    @db.Decimal(14, 6)
  uom            String
  wasteFactorPct Decimal    @default(0) @db.Decimal(5, 2)
  notes          String?

  @@map("bom_lines")
}

model ProductionOrder {
  id                  String                @id @default(uuid())
  orderNumber         String                @unique @default(cuid())
  recipeId            String
  recipe              Recipe                @relation(fields: [recipeId], references: [id])
  recipeVersion       Int
  plannedQty          Decimal               @db.Decimal(10, 4)
  actualQty           Decimal?              @db.Decimal(10, 4)
  status              ProductionOrderStatus @default(DRAFT)
  scheduledDate       DateTime
  shift               String?
  linkedSalesOrderIds String[]
  startedAt           DateTime?
  completedAt         DateTime?
  notes               String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  createdBy           String
  creator             User                  @relation("CreatedBy", fields: [createdBy], references: [id])

  consumptions ProductionConsumption[]
  wasteLogs    WasteLog[]

  @@index([scheduledDate, status])
  @@map("production_orders")
}

model ProductionConsumption {
  id                String          @id @default(uuid())
  productionOrderId String
  productionOrder   ProductionOrder @relation(fields: [productionOrderId], references: [id])
  ingredientId      String
  batchId           String?
  plannedQty        Decimal         @db.Decimal(14, 4)
  actualQty         Decimal?        @db.Decimal(14, 4)
  variance          Decimal?        @db.Decimal(14, 4) // actual - planned
  postedAt          DateTime?

  @@map("production_consumptions")
}

model WasteLog {
  id                String          @id @default(uuid())
  productionOrderId String
  productionOrder   ProductionOrder @relation(fields: [productionOrderId], references: [id])
  ingredientId      String
  wasteType         WasteType
  qty               Decimal         @db.Decimal(14, 4)
  costValue         Decimal         @db.Decimal(14, 4)
  reason            String?
  recordedBy        String
  createdAt         DateTime        @default(now())

  @@map("waste_logs")
}

// ══════════════════════════════════════════════════════════════
//  SUPPLIERS & PROCUREMENT
// ══════════════════════════════════════════════════════════════

model Supplier {
  id                 String   @id @default(uuid())
  businessName       String
  ruc                String   @unique
  contactName        String?
  email              String?
  phone              String?
  address            String?
  paymentTermsDays   Int      @default(30)
  currency           String   @default("PEN")
  rating             Int?
  isActive           Boolean  @default(true)
  notes              String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  priceLists     SupplierPriceList[]
  purchaseOrders PurchaseOrder[]
  performance    SupplierPerformance[]

  @@map("suppliers")
}

model SupplierPriceList {
  id           String     @id @default(uuid())
  supplierId   String
  supplier     Supplier   @relation(fields: [supplierId], references: [id])
  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])
  unitPrice    Decimal    @db.Decimal(12, 4)
  uom          String
  currency     String     @default("PEN")
  validFrom    DateTime
  validTo      DateTime?
  moq          Decimal?   @db.Decimal(14, 4)
  leadTimeDays Int        @default(1)
  createdAt    DateTime   @default(now())

  @@index([supplierId, ingredientId, validFrom])
  @@map("supplier_price_lists")
}

model SupplierPerformance {
  id                   String   @id @default(uuid())
  supplierId           String
  supplier             Supplier @relation(fields: [supplierId], references: [id])
  period               String   // YYYY-MM
  poCount              Int      @default(0)
  onTimeDeliveryPct    Decimal? @db.Decimal(5, 2)
  avgLeadTimeDays      Decimal? @db.Decimal(6, 2)
  priceVariancePct     Decimal? @db.Decimal(5, 2)
  invoiceAccuracyPct   Decimal? @db.Decimal(5, 2)
  updatedAt            DateTime @updatedAt

  @@unique([supplierId, period])
  @@map("supplier_performance")
}

model PurchaseOrder {
  id                   String              @id @default(uuid())
  poNumber             String              @unique
  supplierId           String
  supplier             Supplier            @relation(fields: [supplierId], references: [id])
  status               PurchaseOrderStatus @default(DRAFT)
  currency             String              @default("PEN")
  exchangeRate         Decimal             @default(1) @db.Decimal(8, 4)
  subtotalPen          Decimal             @default(0) @db.Decimal(14, 4)
  igvPen               Decimal             @default(0) @db.Decimal(14, 4)
  totalPen             Decimal             @default(0) @db.Decimal(14, 4)
  expectedDeliveryDate DateTime?
  approvedBy           String?
  approver             User?               @relation("ApprovedBy", fields: [approvedBy], references: [id])
  approvedAt           DateTime?
  sentAt               DateTime?
  notes                String?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  createdBy            String

  lines        PurchaseOrderLine[]
  receipts     GoodsReceiptNote[]
  invoices     SupplierInvoice[]
  comprobantes Comprobante[]

  @@index([status, expectedDeliveryDate])
  @@map("purchase_orders")
}

model PurchaseOrderLine {
  id              String        @id @default(uuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  ingredientId    String
  ingredient      Ingredient    @relation(fields: [ingredientId], references: [id])
  qtyOrdered      Decimal       @db.Decimal(14, 4)
  qtyReceived     Decimal       @default(0) @db.Decimal(14, 4)
  uom             String
  unitPrice       Decimal       @db.Decimal(12, 4)
  lineTotalPen    Decimal       @db.Decimal(14, 4)
  notes           String?

  @@map("purchase_order_lines")
}

model GoodsReceiptNote {
  id                String        @id @default(uuid())
  grnNumber         String        @unique
  purchaseOrderId   String
  purchaseOrder     PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  receivedDate      DateTime
  warehouseId       String
  receivedBy        String
  notes             String?
  createdAt         DateTime      @default(now())

  lines GoodsReceiptLine[]

  @@map("goods_receipt_notes")
}

model GoodsReceiptLine {
  id                 String           @id @default(uuid())
  grnId              String
  grn                GoodsReceiptNote @relation(fields: [grnId], references: [id])
  purchaseOrderLineId String
  ingredientId       String
  qtyReceived        Decimal          @db.Decimal(14, 4)
  batchId            String?
  unitCostPen        Decimal          @db.Decimal(14, 6)
  notes              String?

  @@map("goods_receipt_lines")
}

model SupplierInvoice {
  id              String        @id @default(uuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  invoiceNumber   String
  invoiceDate     DateTime
  dueDate         DateTime?
  subtotalPen     Decimal       @db.Decimal(14, 4)
  igvPen          Decimal       @db.Decimal(14, 4)
  totalPen        Decimal       @db.Decimal(14, 4)
  matchStatus     MatchStatus   @default(PENDING)
  paymentStatus   PaymentStatus @default(UNPAID)
  discrepancyNote String?
  postedAt        DateTime?
  journalEntryId  String?
  createdAt       DateTime      @default(now())
  createdBy       String

  @@map("supplier_invoices")
}

// ══════════════════════════════════════════════════════════════
//  PRODUCT CATALOG
// ══════════════════════════════════════════════════════════════

model ProductCategory {
  id          String  @id @default(uuid())
  name        String  @unique
  parentId    String?
  parent      ProductCategory?  @relation("CategoryTree", fields: [parentId], references: [id])
  children    ProductCategory[] @relation("CategoryTree")
  isActive    Boolean @default(true)

  products Product[]

  @@map("product_categories")
}

model Product {
  id            String          @id @default(uuid())
  sku           String          @unique
  name          String
  description   String?
  categoryId    String
  category      ProductCategory @relation(fields: [categoryId], references: [id])
  basePricePen  Decimal         @db.Decimal(12, 4)
  taxClass      TaxClass        @default(TAXABLE_IGV18)
  activeRecipeId String?
  unitOfSale    String          @default("unit")
  weightGrams   Int?
  imageUrl      String?
  isActive      Boolean         @default(true)
  isB2cVisible  Boolean         @default(true)
  isB2bVisible  Boolean         @default(true)
  minOrderQty   Decimal         @default(1) @db.Decimal(10, 2)
  metadata      Json?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  recipes          Recipe[]
  orderLines       SalesOrderLine[]
  priceAgreements  CustomerPriceAgreement[]
  invoiceLines     InvoiceLineItem[]
  forecastLines    ForecastLine[]
  planLines        ProductionPlanLine[]

  @@map("products")
}

// ══════════════════════════════════════════════════════════════
//  CUSTOMERS & SALES
// ══════════════════════════════════════════════════════════════

model Customer {
  id                  String            @id @default(uuid())
  type                CustomerType
  category            CustomerCategory?           // required for B2B, null for B2C
  displayName         String
  docType             DocType
  docNumber           String            @unique
  email               String?
  phone               String?
  creditLimitPen      Decimal      @default(0) @db.Decimal(14, 4)
  paymentTermsDays    Int          @default(0)
  assignedSalesAgentId String?
  isActive            Boolean      @default(true)
  notes               String?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  addresses       CustomerAddress[]
  contacts        CustomerContact[]
  sucursales      Sucursal[]
  salesOrders     SalesOrder[]
  priceAgreements CustomerPriceAgreement[]
  invoices        Invoice[]

  @@map("customers")
}

model CustomerAddress {
  id           String   @id @default(uuid())
  customerId   String
  customer     Customer @relation(fields: [customerId], references: [id])
  label        String   // e.g. "Main Warehouse", "Office"
  addressLine1 String
  addressLine2 String?
  district     String
  province     String
  department   String
  country      String   @default("Peru")
  isDefault    Boolean  @default(false)
  deliveryNotes String?

  @@map("customer_addresses")
}

model CustomerContact {
  id               String   @id @default(uuid())
  customerId       String
  customer         Customer @relation(fields: [customerId], references: [id])
  fullName         String
  role             String?  // buyer|finance|delivery
  email            String?
  phone            String?
  isPrimary        Boolean  @default(false)
  receivesFacturas Boolean  @default(false)

  @@map("customer_contacts")
}

// Branch / store for B2B customers — one customer can have many delivery points
model Sucursal {
  id              String   @id @default(uuid())
  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id])
  name            String                          // e.g. "Wong Miraflores"

  // Point of contact at this branch
  contactName     String?
  contactPhone    String?
  contactEmail    String?

  // Physical address
  addressLine1    String
  addressLine2    String?
  district        String
  province        String   @default("Lima")
  department      String   @default("Lima")

  // Delivery schedule
  deliveryFrequency  String?   // WEEKLY | BIWEEKLY | MONTHLY | CUSTOM
  deliveryDays       String[]  @default([])   // MON | TUE | WED | THU | FRI | SAT | SUN
  deliveryUnitsQty   Decimal?  @db.Decimal(10, 2)  // units per delivery
  deliveryHour       String?   // e.g. "09:00"
  deliveryNotes      String?

  isActive        Boolean  @default(true)
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([customerId])
  @@map("sucursales")
}

model CustomerPriceAgreement {
  id            String      @id @default(uuid())
  customerId    String
  customer      Customer    @relation(fields: [customerId], references: [id])
  productId     String
  product       Product     @relation(fields: [productId], references: [id])
  pricingType   PricingType
  value         Decimal     @db.Decimal(12, 4) // fixed price or discount %
  effectiveFrom DateTime
  effectiveTo   DateTime?
  approvedBy    String?
  contractNotes String?
  createdAt     DateTime    @default(now())
  createdBy     String

  @@index([customerId, productId, effectiveFrom])
  @@map("customer_price_agreements")
}

model SalesOrder {
  id                String       @id @default(uuid())
  orderNumber       String       @unique
  customerId        String
  customer          Customer     @relation(fields: [customerId], references: [id])
  channel           OrderChannel
  status            OrderStatus  @default(CART)
  subtotalPen       Decimal      @db.Decimal(14, 4)
  igvPen            Decimal      @db.Decimal(14, 4)
  totalPen          Decimal      @db.Decimal(14, 4)
  currency          String       @default("PEN")
  deliveryAddressId String?
  deliveryDate      DateTime?
  deliveryJobId     String?
  invoiceId         String?
  paymentStatus     PaymentStatus @default(UNPAID)
  confirmedAt       DateTime?
  notes             String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  createdBy         String

  lines    SalesOrderLine[]
  payments PaymentRecord[]

  @@index([status, deliveryDate])
  @@index([customerId, createdAt])
  @@map("sales_orders")
}

model SalesOrderLine {
  id              String     @id @default(uuid())
  salesOrderId    String
  salesOrder      SalesOrder @relation(fields: [salesOrderId], references: [id])
  productId       String
  product         Product    @relation(fields: [productId], references: [id])
  qty             Decimal    @db.Decimal(10, 4)
  unitPrice       Decimal    @db.Decimal(12, 4)
  lineTotalPen    Decimal    @db.Decimal(14, 4)
  pricingSource   String?    // PRICE_AGREEMENT | STANDARD_LIST | PROMO_CODE
  discountPct     Decimal?   @db.Decimal(5, 2)
  notes           String?

  @@map("sales_order_lines")
}

model PaymentRecord {
  id             String     @id @default(uuid())
  salesOrderId   String?
  salesOrder     SalesOrder? @relation(fields: [salesOrderId], references: [id])
  invoiceId      String?
  method         String     // CASH|YAPE|PLIN|CARD_CULQI|CARD_NIUBIZ|BANK_TRANSFER|CREDIT
  amountPen      Decimal    @db.Decimal(14, 4)
  currency       String     @default("PEN")
  referenceNo    String?
  gatewayTxnId   String?
  paidAt         DateTime
  notes          String?
  journalEntryId String?
  createdBy      String
  createdAt      DateTime   @default(now())

  @@map("payment_records")
}

// ══════════════════════════════════════════════════════════════
//  INVOICING (MASTER TRANSACTION TABLE)
// ══════════════════════════════════════════════════════════════

model Invoice {
  id                   String            @id @default(uuid())
  docType              InvoiceDocType
  series               String
  correlative          String
  issueDate            DateTime
  entityType           InvoiceEntityType
  entityId             String?
  customer             Customer?         @relation(fields: [entityId], references: [id], map: "invoice_customer_fk")
  entityDocNo          String
  entityName           String
  entityEmail          String?
  subtotalPen          Decimal           @db.Decimal(14, 4)
  igvPen               Decimal           @db.Decimal(14, 4)
  totalPen             Decimal           @db.Decimal(14, 4)
  currency             String            @default("PEN")
  exchangeRate         Decimal           @default(1) @db.Decimal(8, 4)
  status               InvoiceStatus     @default(DRAFT)
  paymentStatus        PaymentStatus     @default(UNPAID)
  paymentDueDate       DateTime?
  linkedCreditNoteIds  String[]
  cdrResponse          Json?
  hashCpe              String?
  qrCodeUrl            String?
  rejectionReason      String?
  nubefactId           String?
  pdfUrl               String?
  xmlUrl               String?
  salesOrderId         String?
  voidedAt             DateTime?
  createdAt            DateTime          @default(now())
  createdBy            String

  lines          InvoiceLineItem[]
  journalEntry   JournalEntry?     @relation(fields: [journalEntryId], references: [id])
  journalEntryId String?
  comprobantes   Comprobante[]

  @@unique([series, correlative])
  @@index([docType, status, issueDate(sort: Desc)])
  @@index([entityId, entityType])
  @@index([paymentStatus, paymentDueDate])
  @@map("invoices")
}

model InvoiceLineItem {
  id          String  @id @default(uuid())
  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id])
  productId   String?
  product     Product? @relation(fields: [productId], references: [id])
  description String
  qty         Decimal @db.Decimal(10, 4)
  unitPrice   Decimal @db.Decimal(12, 4)
  igvRate     Decimal @default(0.18) @db.Decimal(5, 4)
  subtotal    Decimal @db.Decimal(14, 4)
  igv         Decimal @db.Decimal(14, 4)
  total       Decimal @db.Decimal(14, 4)

  @@map("invoice_line_items")
}

// ══════════════════════════════════════════════════════════════
//  ACCOUNTING (DOUBLE-ENTRY GL)
// ══════════════════════════════════════════════════════════════

model ChartOfAccount {
  id              String   @id @default(uuid())
  code            String   @unique
  name            String
  type            String   // ASSET|LIABILITY|EQUITY|REVENUE|EXPENSE
  normalBalance   String   // DEBIT|CREDIT
  parentCode      String?
  isActive        Boolean  @default(true)
  allowDirectPost Boolean  @default(true)
  description     String?

  journalLines JournalLine[]

  @@map("chart_of_accounts")
}

model CostCenter {
  id          String  @id @default(uuid())
  code        String  @unique
  name        String
  isActive    Boolean @default(true)
  parentId    String?

  journalLines JournalLine[]

  @@map("cost_centers")
}

model AccountingPeriod {
  id        String   @id @default(uuid())
  year      Int
  month     Int      // 1-12
  status    String   @default("OPEN") // OPEN|CLOSED
  closedAt  DateTime?
  closedBy  String?

  journalEntries JournalEntry[]

  @@unique([year, month])
  @@map("accounting_periods")
}

model JournalEntry {
  id            String             @id @default(uuid())
  entryNumber   String             @unique
  entryDate     DateTime
  periodId      String
  period        AccountingPeriod   @relation(fields: [periodId], references: [id])
  description   String
  sourceModule  SourceModule
  sourceDocId   String?
  status        JournalEntryStatus @default(DRAFT)
  totalDebit    Decimal            @db.Decimal(14, 4)
  totalCredit   Decimal            @db.Decimal(14, 4)
  reversedById  String?
  createdAt     DateTime           @default(now())
  createdBy     String
  creator       User               @relation(fields: [createdBy], references: [id])

  lines    JournalLine[]
  invoices Invoice[]

  @@index([periodId, status])
  @@index([sourceModule, sourceDocId])
  @@map("journal_entries")
}

model JournalLine {
  id             String          @id @default(uuid())
  entryId        String
  entry          JournalEntry    @relation(fields: [entryId], references: [id])
  accountId      String
  account        ChartOfAccount  @relation(fields: [accountId], references: [id])
  costCenterId   String?
  costCenter     CostCenter?     @relation(fields: [costCenterId], references: [id])
  debit          Decimal         @default(0) @db.Decimal(14, 4)
  credit         Decimal         @default(0) @db.Decimal(14, 4)
  description    String?

  @@map("journal_lines")
}

model BankStatement {
  id              String   @id @default(uuid())
  bankAccountCode String   // maps to chart_of_accounts code
  statementDate   DateTime
  importedAt      DateTime @default(now())
  importedBy      String

  transactions BankTransaction[]

  @@map("bank_statements")
}

model BankTransaction {
  id                String       @id @default(uuid())
  statementId       String
  statement         BankStatement @relation(fields: [statementId], references: [id])
  transactionDate   DateTime
  description       String
  debitAmount       Decimal?     @db.Decimal(14, 4)
  creditAmount      Decimal?     @db.Decimal(14, 4)
  balance           Decimal      @db.Decimal(14, 4)
  reference         String?
  isReconciled      Boolean      @default(false)
  journalLineId     String?
  reconciledAt      DateTime?
  reconciledBy      String?

  @@map("bank_transactions")
}

// ══════════════════════════════════════════════════════════════
//  DELIVERY
// ══════════════════════════════════════════════════════════════

model Driver {
  id          String  @id @default(uuid())
  employeeId  String  @unique
  licenseNo   String
  vehicleId   String?
  isAvailable Boolean @default(true)
  isActive    Boolean @default(true)

  employee Employee       @relation(fields: [employeeId], references: [id])
  routes   DeliveryRoute[]

  @@map("drivers")
}

model DeliveryRoute {
  id                    String              @id @default(uuid())
  routeCode             String              @unique
  scheduledDate         DateTime
  driverId              String
  driver                Driver              @relation(fields: [driverId], references: [id])
  vehicleId             String?
  status                DeliveryRouteStatus @default(PLANNED)
  estimatedDistanceKm   Decimal?            @db.Decimal(8, 2)
  actualDistanceKm      Decimal?            @db.Decimal(8, 2)
  fuelCostPen           Decimal?            @db.Decimal(10, 4)
  totalCostPen          Decimal?            @db.Decimal(10, 4)
  notes                 String?
  createdAt             DateTime            @default(now())
  createdBy             String

  jobs DeliveryJob[]

  @@index([scheduledDate, status])
  @@map("delivery_routes")
}

model DeliveryJob {
  id                   String            @id @default(uuid())
  routeId              String
  route                DeliveryRoute     @relation(fields: [routeId], references: [id])
  salesOrderId         String
  sequence             Int
  deliveryAddressLine  String
  customerContact      String?
  customerPhone        String?
  scheduledTimeWindow  String?           // e.g. "09:00-12:00"
  actualDeliveryTime   DateTime?
  status               DeliveryJobStatus @default(PENDING)
  proofOfDeliveryUrl   String?
  signature            String?
  notes                String?
  createdAt            DateTime          @default(now())

  incidents DeliveryIncident[]

  @@map("delivery_jobs")
}

model DeliveryIncident {
  id           String       @id @default(uuid())
  jobId        String
  job          DeliveryJob  @relation(fields: [jobId], references: [id])
  type         IncidentType
  notes        String
  photoUrl     String?
  resolution   String?
  reportedBy   String
  createdAt    DateTime     @default(now())

  @@map("delivery_incidents")
}

// ══════════════════════════════════════════════════════════════
//  PAYROLL
// ══════════════════════════════════════════════════════════════

model Employee {
  id              String         @id @default(uuid())
  fullName        String
  nombres         String?
  apellidoPaterno String?
  apellidoMaterno String?
  seguroSalud     String?        // ESSALUD | EPS | ESSALUD_EPS | SIS | SCTR
  dni             String         @unique
  cuspp           String?        // AFP code (CUSPP = Código Único de Sistema de Pensiones)
  contractType    ContractType   @default(INDEFINIDO)
  hireDate        DateTime       @default(now())
  birthDate       DateTime?
  terminationDate DateTime?
  baseSalary      Decimal        @db.Decimal(12, 4)
  position        String
  department      String?
  employmentType  EmploymentType @default(PLANILLA)
  pensionSystem   PensionSystem  @default(AFP)
  afpId           String?        // AFP institution ID (legacy)
  afpName         String?        // AFP name: "AFP Integra" | "Prima AFP" | "Profuturo AFP" | "Habitat AFP"
  email           String?        // for payslip delivery
  isActive        Boolean        @default(true)
  bankAccount     String?
  bankName        String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  payslips        Payslip[]
  leaveRecords    LeaveRecord[]
  overtimeRecords OvertimeRecord[]
  driver          Driver?

  @@map("employees")
}

model PayPeriod {
  id          String          @id @default(uuid())
  periodType  PayPeriodType
  year        Int
  month       Int
  fortnight   Int?            // 1 or 2 for QUINCENA
  status      PayPeriodStatus @default(OPEN)
  processedAt DateTime?
  processedBy String?
  paidAt      DateTime?
  paidBy      String?
  closedAt    DateTime?
  closedBy    String?

  payslips Payslip[]

  @@unique([periodType, year, month, fortnight])
  @@map("pay_periods")
}

model Payslip {
  id                 String        @id @default(uuid())
  employeeId         String
  employee           Employee      @relation(fields: [employeeId], references: [id])
  periodId           String
  period             PayPeriod     @relation(fields: [periodId], references: [id])
  grossSalary        Decimal       @db.Decimal(12, 4)
  additions          Json          // { overtime25: X, overtime35: Y, holidayPay: Z, bonuses: 0 }
  deductions         Json          // { afpOrOnp: X, igv5taCategoria: Y, irRxH: Z, otherDeductions: 0 }
  netSalary          Decimal       @db.Decimal(12, 4)
  igv5taWithheld     Decimal       @default(0) @db.Decimal(12, 4)
  essaludEmployer    Decimal       @default(0) @db.Decimal(12, 4)
  ctsProvision       Decimal       @default(0) @db.Decimal(12, 4)
  vacationProvision  Decimal       @default(0) @db.Decimal(12, 4)
  gratificacionProv  Decimal       @default(0) @db.Decimal(12, 4)
  employerTotalCost  Decimal       @db.Decimal(12, 4)
  notes              String?       // manual adjustment notes
  status             PayslipStatus @default(DRAFT)
  confirmedAt        DateTime?
  confirmedBy        String?
  paidAt             DateTime?
  paidBy             String?
  emailSentAt        DateTime?
  journalEntryId     String?
  generatedAt        DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  @@unique([employeeId, periodId])
  @@map("payslips")
}

model LeaveRecord {
  id          String   @id @default(uuid())
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id])
  leaveType   String   // VACATION|SICK|UNPAID|OTHER
  startDate   DateTime
  endDate     DateTime
  daysTaken   Int
  approvedBy  String?
  notes           String?
  manualBonuses   Decimal  @default(0)
  manualDeductions Decimal  @default(0)
  createdAt   DateTime @default(now())

  @@map("leave_records")
}

model OvertimeRecord {
  id           String   @id @default(uuid())
  employeeId   String
  employee     Employee @relation(fields: [employeeId], references: [id])
  date         DateTime
  hoursWorked  Decimal  @db.Decimal(5, 2)
  regularHours Decimal  @db.Decimal(5, 2)
  overtime25   Decimal  @default(0) @db.Decimal(5, 2)  // hours at 25% surcharge
  overtime35   Decimal  @default(0) @db.Decimal(5, 2)  // hours at 35% surcharge
  isHoliday    Boolean  @default(false)                 // holiday work = 100% surcharge (double pay)
  holidayHours Decimal  @default(0) @db.Decimal(5, 2)  // hours worked on holiday
  notes        String?
  approvedBy   String?
  createdAt    DateTime @default(now())

  @@map("overtime_records")
}

// ══════════════════════════════════════════════════════════════
//  AI FORECASTING & PRODUCTION PLANNING
// ══════════════════════════════════════════════════════════════

model ForecastRun {
  id           String         @id @default(uuid())
  runDate      DateTime       @default(now())
  modelVersion String
  triggeredBy  String
  status       ForecastStatus @default(RUNNING)
  mapeOverall  Decimal?       @db.Decimal(6, 4)
  notes        String?
  completedAt  DateTime?

  versions ForecastVersion[]

  @@map("forecast_runs")
}

model ForecastVersion {
  id          String      @id @default(uuid())
  runId       String
  run         ForecastRun @relation(fields: [runId], references: [id])
  periodStart DateTime
  periodEnd   DateTime
  label       String
  isCurrent   Boolean     @default(false)
  isLocked    Boolean     @default(false)
  createdAt   DateTime    @default(now())

  lines            ForecastLine[]
  accuracyRecords  ForecastAccuracy[]
  planSuggestions  ProductionPlanSuggestion[]

  @@map("forecast_versions")
}

model ForecastLine {
  id                    String          @id @default(uuid())
  versionId             String
  version               ForecastVersion @relation(fields: [versionId], references: [id])
  productId             String
  product               Product         @relation(fields: [productId], references: [id])
  customerId            String?         // null = B2C aggregate
  forecastMonth         DateTime        // first day of month
  forecastQty           Decimal         @db.Decimal(14, 4)
  lowerBoundQty         Decimal?        @db.Decimal(14, 4)
  upperBoundQty         Decimal?        @db.Decimal(14, 4)
  isManuallyOverridden  Boolean         @default(false)
  lockUntilDate         DateTime?
  originalModelQty      Decimal?        @db.Decimal(14, 4)
  overriddenBy          String?
  overriddenAt          DateTime?

  @@index([versionId, productId, forecastMonth])
  @@map("forecast_lines")
}

model ForecastAccuracy {
  id           String          @id @default(uuid())
  versionId    String
  version      ForecastVersion @relation(fields: [versionId], references: [id])
  productId    String
  month        DateTime
  forecastQty  Decimal         @db.Decimal(14, 4)
  actualQty    Decimal         @db.Decimal(14, 4)
  mape         Decimal?        @db.Decimal(6, 4)
  wmape        Decimal?        @db.Decimal(6, 4)
  evaluatedAt  DateTime        @default(now())

  @@map("forecast_accuracy")
}

model ProductionPlanSuggestion {
  id          String               @id @default(uuid())
  versionId   String
  version     ForecastVersion      @relation(fields: [versionId], references: [id])
  status      PlanSuggestionStatus @default(SUGGESTED)
  generatedAt DateTime             @default(now())
  confirmedAt DateTime?
  confirmedBy String?
  notes           String?
  manualBonuses   Decimal  @default(0)
  manualDeductions Decimal  @default(0)

  lines                 ProductionPlanLine[]
  purchaseRecommendations PurchaseRecommendation[]

  @@map("production_plan_suggestions")
}

model ProductionPlanLine {
  id              String                   @id @default(uuid())
  suggestionId    String
  suggestion      ProductionPlanSuggestion @relation(fields: [suggestionId], references: [id])
  productId       String
  product         Product                  @relation(fields: [productId], references: [id])
  productionDate  DateTime
  suggestedQty    Decimal                  @db.Decimal(14, 4)
  adjustedQty     Decimal?                 @db.Decimal(14, 4)
  capacityPct     Decimal?                 @db.Decimal(5, 2)
  demandSource    DemandSource

  @@map("production_plan_lines")
}

model PurchaseRecommendation {
  id                      String                   @id @default(uuid())
  suggestionId            String
  suggestion              ProductionPlanSuggestion @relation(fields: [suggestionId], references: [id])
  ingredientId            String
  supplierId              String?
  recommendedQty          Decimal                  @db.Decimal(14, 4)
  recommendedOrderDate    DateTime
  estimatedDeliveryDate   DateTime
  estimatedCostPen        Decimal?                 @db.Decimal(14, 4)
  isActedOn               Boolean                  @default(false)
  purchaseOrderId         String?

  @@map("purchase_recommendations")
}

// ══════════════════════════════════════════════════════════════
//  COMPROBANTES — DOCUMENT REGISTRY (SUSTENTO)
//  Stores facturas, boletas, OC, guías, etc. linked to any
//  business event.  Files are kept as base64 inside the DB.
// ══════════════════════════════════════════════════════════════

model Comprobante {
  id              String            @id @default(uuid())

  // What this sustento is for
  tipoDoc         ComprobanteDocType?              // Primary document type classification
  descripcion     String
  fecha           DateTime
  moneda          String            @default("PEN")
  montoTotal      Decimal?          @db.Decimal(14, 4)

  // Optional links to other modules
  purchaseOrderId   String?
  purchaseOrder     PurchaseOrder?  @relation(fields: [purchaseOrderId], references: [id])
  invoiceId         String?
  invoice           Invoice?        @relation(fields: [invoiceId], references: [id])
  /// Free-form reference to a bank consolidation row (accountId:YYYY-MM)
  consolidacionRef  String?

  // Ingestion source
  source          ComprobanteSource @default(MANUAL)
  senderEmail     String?           // email address that sent this, if source = EMAIL
  emailSubject    String?           // original email subject

  // Status & metadata
  estado          ComprobanteEstado @default(PENDIENTE)
  notas           String?
  tags            String[]          @default([])
  createdAt       DateTime          @default(now())
  createdBy       String
  updatedAt       DateTime          @updatedAt

  archivos        ComprobanteArchivo[]

  @@index([fecha])
  @@index([estado])
  @@index([source])
  @@index([purchaseOrderId])
  @@map("comprobantes")
}

model ComprobanteArchivo {
  id              String                  @id @default(uuid())
  comprobanteId   String
  comprobante     Comprobante             @relation(fields: [comprobanteId], references: [id], onDelete: Cascade)

  // What kind of document this file represents
  docType         ComprobanteDocType
  archivoTipo     ComprobanteArchivoTipo

  // File payload (base64)
  nombreArchivo   String
  mimeType        String
  tamanoBytes     Int
  dataBase64      String                  @db.Text

  // Auto-extracted metadata (from XML parse or PDF heuristics)
  serie           String?
  correlativo     String?
  numero          String?                 // serie + '-' + correlativo
  fechaEmision    DateTime?
  emisorRuc       String?
  emisorNombre    String?
  receptorRuc     String?
  receptorNombre  String?
  monedaDoc       String?
  subtotal        Decimal?                @db.Decimal(14, 4)
  igv             Decimal?                @db.Decimal(14, 4)
  total           Decimal?                @db.Decimal(14, 4)

  createdAt       DateTime                @default(now())

  @@index([comprobanteId])
  @@index([emisorRuc])
  @@index([numero])
  @@map("comprobante_archivos")
}

// ══════════════════════════════════════════════════════════════
//  COMMUNICATIONS LOG
// ══════════════════════════════════════════════════════════════

model CommunicationLog {
  id          String   @id @default(uuid())
  channel     String   // EMAIL|WHATSAPP|SMS
  recipient   String
  template    String
  payload     Json?
  status      String   // SENT|DELIVERED|FAILED|BOUNCED
  externalId  String?
  errorMsg    String?
  triggeredBy String?
  createdAt   DateTime @default(now())

  @@map("communication_logs")
}
